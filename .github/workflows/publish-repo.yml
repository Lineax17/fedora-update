name: Publish Repositories

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-rpm-repo:
    runs-on: ubuntu-latest
    name: Build RPM Repository

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Download Release RPMs
        uses: robinraju/release-downloader@v1.9
        with:
          latest: true
          fileName: "*.noarch.rpm"
          out-file-path: "rpm-packages"

      - name: Generate RPM repository metadata
        run: |
          podman pull docker.io/library/fedora:latest
          podman run --rm \
            -v $PWD:/workspace \
            -w /workspace \
            docker.io/library/fedora:latest \
            bash -c "
              dnf -y install createrepo_c && \
              createrepo_c rpm-packages
            "

      - name: Upload RPM repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-repo
          path: rpm-packages/

  build-deb-repo:
    runs-on: ubuntu-latest
    name: Build DEB Repository

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Release DEBs
        uses: robinraju/release-downloader@v1.9
        with:
          latest: true
          fileName: "*.deb"
          out-file-path: "deb-packages"

      - name: Generate APT repository metadata
        run: |
          cd deb-packages

          # Generate package list (uncompressed and compressed)
          dpkg-scanpackages . /dev/null > Packages
          gzip -9c Packages > Packages.gz

          # Calculate checksums for Packages files
          MD5_PACKAGES=$(md5sum Packages | awk '{print $1}')
          MD5_PACKAGES_GZ=$(md5sum Packages.gz | awk '{print $1}')
          SHA256_PACKAGES=$(sha256sum Packages | awk '{print $1}')
          SHA256_PACKAGES_GZ=$(sha256sum Packages.gz | awk '{print $1}')
          SHA512_PACKAGES=$(sha512sum Packages | awk '{print $1}')
          SHA512_PACKAGES_GZ=$(sha512sum Packages.gz | awk '{print $1}')

          SIZE_PACKAGES=$(stat -c%s Packages)
          SIZE_PACKAGES_GZ=$(stat -c%s Packages.gz)

          # Create Release file with checksums
          cat > Release << EOF
          Origin: Tuxgrade
          Label: Tuxgrade
          Suite: stable
          Codename: stable
          Date: $(date -R -u)
          Architectures: all
          Components: main
          Description: Tuxgrade - Linux System Updater
          MD5Sum:
           ${MD5_PACKAGES} ${SIZE_PACKAGES} Packages
           ${MD5_PACKAGES_GZ} ${SIZE_PACKAGES_GZ} Packages.gz
          SHA256:
           ${SHA256_PACKAGES} ${SIZE_PACKAGES} Packages
           ${SHA256_PACKAGES_GZ} ${SIZE_PACKAGES_GZ} Packages.gz
          SHA512:
           ${SHA512_PACKAGES} ${SIZE_PACKAGES} Packages
           ${SHA512_PACKAGES_GZ} ${SIZE_PACKAGES_GZ} Packages.gz
          EOF

      - name: Upload DEB repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-repo
          path: deb-packages/

  combine-and-deploy:
    needs: [build-rpm-repo, build-deb-repo]
    runs-on: ubuntu-latest
    name: Combine and Deploy to GitHub Pages
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download RPM repository
        uses: actions/download-artifact@v4
        with:
          name: rpm-repo
          path: combined-repo/rpm

      - name: Download DEB repository
        uses: actions/download-artifact@v4
        with:
          name: deb-repo
          path: combined-repo/deb

      - name: Create index page
        run: |
          cat > combined-repo/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Tuxgrade Repository</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              .repo { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
              code { background: #e0e0e0; padding: 2px 6px; border-radius: 3px; }
            </style>
          </head>
          <body>
            <h1>Tuxgrade Package Repository</h1>
            <p>Automated system upgrade tool for multiple Linux distributions.</p>
            
            <div class="repo">
              <h2>Fedora / RHEL / Rocky / AlmaLinux</h2>
              <p>Add the repository:</p>
              <pre><code>sudo curl -o /etc/yum.repos.d/tuxgrade.repo https://raw.githubusercontent.com/Lineax17/tuxgrade/main/extras/tuxgrade.repo</code></pre>
              <p>Install tuxgrade:</p>
              <pre><code>sudo dnf install tuxgrade</code></pre>
            </div>
            
            <div class="repo">
              <h2>Debian / Ubuntu / Linux Mint</h2>
              <p>Add the repository:</p>
              <pre><code>sudo curl -o /etc/apt/sources.list.d/tuxgrade.list https://raw.githubusercontent.com/Lineax17/tuxgrade/main/extras/tuxgrade.list
          sudo apt update</code></pre>
              <p>Install tuxgrade:</p>
              <pre><code>sudo apt install tuxgrade</code></pre>
            </div>
            
            <p><a href="https://github.com/Lineax17/tuxgrade">GitHub Repository</a></p>
          </body>
          </html>
          EOF

      - name: Upload GitHub Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: combined-repo

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
